
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://easyroutine.github.io/api/interpretability/token_index/">
      
      
        <link rel="prev" href="../module_wrapper/">
      
      
        <link rel="next" href="../tools/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Token index - EasyRoutine</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#easyroutine.interpretability.token_index" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="EasyRoutine" class="md-header__button md-logo" aria-label="EasyRoutine" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EasyRoutine
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Token index
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="EasyRoutine" class="md-nav__button md-logo" aria-label="EasyRoutine" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    EasyRoutine
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Api
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Api
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Interpretability
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Interpretability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../activation_cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Activation cache
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hooked_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hooked model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../interventions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interventions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Module Wrapper
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Token index
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Token index
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index" class="md-nav__link">
    <span class="md-ellipsis">
      token_index
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex" class="md-nav__link">
    <span class="md-ellipsis">
      TokenIndex
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TokenIndex">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index" class="md-nav__link">
    <span class="md-ellipsis">
      get_token_index
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_token_index">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index--direct-index-access" class="md-nav__link">
    <span class="md-ellipsis">
      Direct index access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index--named-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      Named tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index--mixed-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Mixed usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index--partition-access" class="md-nav__link">
    <span class="md-ellipsis">
      Partition access
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interpretability Tools
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index" class="md-nav__link">
    <span class="md-ellipsis">
      token_index
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex" class="md-nav__link">
    <span class="md-ellipsis">
      TokenIndex
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TokenIndex">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index" class="md-nav__link">
    <span class="md-ellipsis">
      get_token_index
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_token_index">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index--direct-index-access" class="md-nav__link">
    <span class="md-ellipsis">
      Direct index access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index--named-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      Named tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index--mixed-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Mixed usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#easyroutine.interpretability.token_index.TokenIndex.get_token_index--partition-access" class="md-nav__link">
    <span class="md-ellipsis">
      Partition access
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Token index</h1>

<div class="doc doc-object doc-module">



<a id="easyroutine.interpretability.token_index"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="easyroutine.interpretability.token_index.TokenIndex" class="doc doc-heading">
            <code>TokenIndex</code>


</h2>


    <div class="doc doc-contents ">


        <p>TokenIndex is one of the core class of the interpretability module.
It is used to find the right indexes that correspond to the tokens in the input of the model.
In this way we are able to extract the right hidden states and attention weights, based on the tokens we are interested in.
It support mixed modalities inputs, with both text and images.</p>







              <details class="quote">
                <summary>Source code in <code>easyroutine/interpretability/token_index.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TokenIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TokenIndex is one of the core class of the interpretability module.</span>
<span class="sd">    It is used to find the right indexes that correspond to the tokens in the input of the model.</span>
<span class="sd">    In this way we are able to extract the right hidden states and attention weights, based on the tokens we are interested in.</span>
<span class="sd">    It support mixed modalities inputs, with both text and images.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pivot_positions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pivot_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            model_name: str (required): the name of the model</span>
<span class="sd">            pivot_positions: List[int] (optional): a list of integers that represent the positions where to split the tokens.</span>
<span class="sd">            pivot_tokens: List[str] (optional): a list of strings that represent the tokens where to split the tokens.</span>


<span class="sd">        The pivot_positions and pivot_tokens are mutually exclusive.</span>
<span class="sd">        The idea of the split is the following. Immagine to have an input string of tokens like this: [&quot;I&quot;, &quot;love&quot;, &quot;cats&quot;, &quot;and&quot;, &quot;dogs&quot;. &quot;What&quot;, &quot;about&quot;, &quot;you?&quot;]</span>
<span class="sd">        Then, i want to extract/ablate/intervene on the second sentence. I can do it by specifying the pivot_positions=[5] or pivot_tokens=[&quot;What&quot;].</span>
<span class="sd">        In this way, the tokens will be split in two groups: [&quot;I&quot;, &quot;love&quot;, &quot;cats&quot;, &quot;and&quot;] and [&quot;dogs&quot;, &quot;What&quot;, &quot;about&quot;, &quot;you?&quot;] with names &quot;inputs-partition-0&quot; and &quot;inputs-partition-1&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pivot_tokens</span> <span class="o">=</span> <span class="n">pivot_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pivot_positions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pivot_positions</span><span class="p">)</span> <span class="k">if</span> <span class="n">pivot_positions</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">find_occurrences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lst</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">target</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">categorize_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">string_tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">include_delimiters_in_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_MODELS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported model_name&quot;</span><span class="p">)</span>

        <span class="c1"># Unpack model tokens:</span>
        <span class="c1"># start_image_token: token marking the beginning of an image section</span>
        <span class="c1"># special: special tokens or sequences that might occur inside an image section</span>
        <span class="c1"># end_image_token: token marking the end of an image section</span>
        <span class="n">start_image_token</span><span class="p">,</span> <span class="n">special</span><span class="p">,</span> <span class="n">end_image_token</span> <span class="o">=</span> <span class="n">SUPPORTED_MODELS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>

        <span class="c1"># Convert special to list if it&#39;s a single token</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">special</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">special</span> <span class="o">=</span> <span class="p">[</span><span class="n">special</span><span class="p">]</span>
        <span class="c1"># Convert special tokens to list of lists for uniform processing</span>
        <span class="k">if</span> <span class="n">special</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">special_sequences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">special_sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">special</span><span class="p">]</span>

        <span class="n">image_start_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">image_end_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">image_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_line_image_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">text_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">special_tokens</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Case 1: When the start and end markers differ.</span>
        <span class="k">if</span> <span class="n">start_image_token</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">start_image_token</span> <span class="o">!=</span> <span class="n">end_image_token</span><span class="p">:</span>
            <span class="n">in_image_sequence</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">):</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">string_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="n">start_image_token</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_image_sequence</span><span class="p">:</span>
                    <span class="n">in_image_sequence</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">image_start_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">in_image_sequence</span> <span class="ow">and</span> <span class="n">token</span> <span class="o">==</span> <span class="n">end_image_token</span><span class="p">:</span>
                    <span class="n">in_image_sequence</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">image_end_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">last_line_image_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">in_image_sequence</span><span class="p">:</span>
                    <span class="c1"># Check for special token sequences</span>
                    <span class="n">sequence_found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">special_sequences</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">):</span>
                            <span class="c1"># Check if the current position matches the sequence</span>
                            <span class="k">if</span> <span class="n">string_tokens</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)]</span> <span class="o">==</span> <span class="n">seq</span><span class="p">:</span>
                                <span class="n">special_tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)))</span>
                                <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
                                <span class="n">sequence_found</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                    <span class="k">if</span> <span class="n">sequence_found</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">image_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">text_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Case 2: When the start and end markers are identical.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Collect all indices where the marker appears.</span>
            <span class="n">marker_indices</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">)</span> <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="n">start_image_token</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">marker_indices</span><span class="p">:</span>
                <span class="c1"># Always record the first marker as image_start and the last as image_end.</span>
                <span class="n">image_start_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">marker_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">image_end_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">marker_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># If no explicit flag was provided, inspect the content between the markers:</span>
                <span class="k">if</span> <span class="n">include_delimiters_in_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># If any token between the first and last marker is not the marker itself,</span>
                    <span class="c1"># we assume the markers are used as delimiters.</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">string_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">start_image_token</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">marker_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">marker_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">):</span>
                        <span class="n">include_delimiters_in_image</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">include_delimiters_in_image</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">include_delimiters_in_image</span><span class="p">:</span>
                    <span class="c1"># If markers are part of the image content, include every occurrence.</span>
                    <span class="n">image_tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">marker_indices</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Otherwise, consider only the tokens strictly between the first and last markers.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">marker_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">image_tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">marker_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># (If there are exactly two markers, there is no “internal” image token.)</span>
                <span class="c1"># For this branch, define last_line_image as the position immediately before the last marker.</span>
                <span class="n">last_line_image_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">marker_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Classify all tokens that are not the marker as text.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="n">start_image_token</span><span class="p">:</span>
                    <span class="n">text_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="c1"># Optionally, if special tokens may occur outside the image region:</span>
                <span class="k">if</span> <span class="n">special</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">special</span><span class="p">:</span>
                    <span class="n">special_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">tokens_group</span><span class="p">,</span> <span class="n">positions_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_tokens</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">)</span>
        <span class="n">position_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;inputs-partition-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">positions_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">positions_group</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;image_start&quot;</span><span class="p">:</span> <span class="n">image_start_tokens</span><span class="p">,</span>
            <span class="s2">&quot;image_end&quot;</span><span class="p">:</span> <span class="n">image_end_tokens</span><span class="p">,</span>
            <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_tokens</span><span class="p">,</span>
            <span class="s2">&quot;last_line_image&quot;</span><span class="p">:</span> <span class="n">last_line_image_tokens</span><span class="p">,</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text_tokens</span><span class="p">,</span>
            <span class="s2">&quot;special&quot;</span><span class="p">:</span> <span class="n">special_tokens</span><span class="p">,</span>
            <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">))),</span>
            <span class="o">**</span><span class="n">position_dict</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">group_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">string_tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot_tokens</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_tokens_by_pivot_tokens</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot_positions</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_tokens_by_positions</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">string_tokens</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">)))}</span>

    <span class="k">def</span> <span class="nf">group_tokens_by_positions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">string_tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
        <span class="n">tokens_group</span><span class="p">,</span> <span class="n">positions_group</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pivot_positions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">positions_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">positions_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pivot_positions</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">]</span>
        <span class="n">positions_group</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pivot_positions</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pivot_positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="c1"># modify the positions_group to include all the indexes and not just the start and end</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions_group</span><span class="p">)):</span>
            <span class="n">positions_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">positions_group</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">positions_group</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">positions_group</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tokens_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">string_tokens</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tokens_group</span><span class="p">,</span> <span class="n">positions_group</span>

    <span class="k">def</span> <span class="nf">group_tokens_by_pivot_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">string_tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
        <span class="n">tokens_group</span><span class="p">,</span> <span class="n">positions_group</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">current_group</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pivot_tokens</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot_tokens</span><span class="p">:</span>
                <span class="n">positions_group</span><span class="p">[</span><span class="n">current_group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">tokens_group</span><span class="p">[</span><span class="n">current_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_tokens</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
                <span class="n">current_group</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">start_pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">positions_group</span><span class="p">[</span><span class="n">current_group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_pos</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">)]</span>
        <span class="n">tokens_group</span><span class="p">[</span><span class="n">current_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_tokens</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">tokens_group</span><span class="p">,</span> <span class="n">positions_group</span>

    <span class="k">def</span> <span class="nf">get_token_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tokens</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
            <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
            <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="p">],</span>
        <span class="n">string_tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">return_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get indices for specified tokens in the input sequence.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            tokens: list of tokens to look up. Can be:</span>
<span class="sd">                - String token identifiers (see Supported Tokens below)</span>
<span class="sd">                - Integer indices (direct position access)</span>
<span class="sd">                - Tuple[int, int] for slices (start, end)</span>
<span class="sd">            string_tokens: Input token sequence to search in</span>
<span class="sd">            return_type: Output format:</span>
<span class="sd">                - &quot;list&quot;: Returns [int, ...]</span>
<span class="sd">                - &quot;dict&quot;: Returns {&quot;token_type&quot;: [indices]}</span>
<span class="sd">                - &quot;all&quot;: Returns ([indices], {token_type: [indices]})</span>

<span class="sd">        Returns:</span>
<span class="sd">            Based on return_type, provides token indices in specified format</span>

<span class="sd">        Token Types:</span>
<span class="sd">            1. Direct Access:</span>
<span class="sd">                - Integer index: Direct position (e.g. 5)</span>
<span class="sd">                - Slice tuple: Range of positions (e.g. (2,5))</span>
<span class="sd">                - Negative index: From end (e.g. -1)</span>

<span class="sd">            2. Named Positions:</span>
<span class="sd">                - &quot;last&quot;: Last token</span>
<span class="sd">                - &quot;last-2&quot;: Second to last</span>
<span class="sd">                - &quot;last-4&quot;: Fourth to last</span>

<span class="sd">            3. Text Tokens:</span>
<span class="sd">                - &quot;all-text&quot;: All text positions</span>
<span class="sd">                - &quot;random-text&quot;: Single random text position</span>
<span class="sd">                - &quot;random-text-N&quot;: N random text positions</span>

<span class="sd">            4. Image Tokens:</span>
<span class="sd">                - &quot;all-image&quot;: All image positions</span>
<span class="sd">                - &quot;last-image&quot;: Last image position</span>
<span class="sd">                - &quot;end-image&quot;: Image end marker</span>
<span class="sd">                - &quot;random-image&quot;: Random image position</span>
<span class="sd">                - &quot;random-image-N&quot;: N random image positions</span>

<span class="sd">            5. Special:</span>
<span class="sd">                - &quot;special&quot;: Model-specific tokens</span>
<span class="sd">                - &quot;all&quot;: Complete sequence</span>
<span class="sd">                - &quot;special-pixtral&quot;: Model-specific fixed positions</span>
<span class="sd">                - &quot;inputs-partition-N&quot;: Nth token group</span>
<span class="sd">                - &quot;random-inputs-partition-N&quot;: Random from group N</span>

<span class="sd">        Examples:</span>
<span class="sd">            # Direct index access</span>
<span class="sd">            &gt;&gt;&gt; get_token_index([5], tokens)               # Single position</span>
<span class="sd">            [5]</span>
<span class="sd">            &gt;&gt;&gt; get_token_index([(2,5)], tokens)          # Slice range</span>
<span class="sd">            [2,3,4]</span>
<span class="sd">            &gt;&gt;&gt; get_token_index([-1], tokens)             # From end</span>
<span class="sd">            [9]</span>

<span class="sd">            # Named tokens</span>
<span class="sd">            &gt;&gt;&gt; get_token_index([&quot;last&quot;], tokens)         # Last token</span>
<span class="sd">            [9]</span>
<span class="sd">            &gt;&gt;&gt; get_token_index([&quot;all-text&quot;], tokens)     # All text</span>
<span class="sd">            [0,1,2,3]</span>

<span class="sd">            # Mixed usage</span>
<span class="sd">            &gt;&gt;&gt; get_token_index([&quot;last&quot;, (2,5)], tokens, return_type=&quot;dict&quot;)</span>
<span class="sd">            {&quot;last&quot;: [9], &quot;numeric&quot;: [2,3,4]}</span>

<span class="sd">            # Partition access</span>
<span class="sd">            &gt;&gt;&gt; get_token_index([&quot;inputs-partition-0&quot;], tokens)  # First group</span>
<span class="sd">            [0,1,2]</span>
<span class="sd">            &gt;&gt;&gt; get_token_index([&quot;random-inputs-partition-0&quot;], tokens) # Random from group</span>
<span class="sd">            [1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert single token to list for uniform processing</span>
        <span class="c1"># assert that we have a list of tokens</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Tokens must be a list of strings or integers or tuples. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Check if all tokens are supported or not</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">token</span> <span class="ow">in</span> <span class="n">SUPPORTED_TOKENS</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;inputs-partition-&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-inputs-partition-&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-image&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-text&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported token type into: </span><span class="si">{</span><span class="n">tokens</span><span class="si">}</span><span class="s2">. Supported tokens are: </span><span class="si">{</span><span class="n">SUPPORTED_TOKENS</span><span class="si">}</span><span class="s2"> and inputs-partition-0, inputs-partition-1, etc or random-inputs-partition-0, random-inputs-partition-1, etc or integer indices or slices (tuple of start, end)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check if pivot_positions is required but not provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot_positions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span>
                <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;inputs-partition-&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-inputs-partition-&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;pivot_positions cannot be None when a group position token is requested&quot;</span>
            <span class="p">)</span>

        <span class="n">token_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorize_tokens</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">)</span>
        <span class="n">tokens_positions</span><span class="p">,</span> <span class="n">token_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tokens_positions</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">token_indexes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">token_dict</span>
        <span class="k">if</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tokens_positions</span><span class="p">,</span> <span class="n">token_dict</span>
        <span class="k">return</span> <span class="n">tokens_positions</span>

    <span class="k">def</span> <span class="nf">get_tokens_positions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
        <span class="n">token_indexes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">tokens_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">position_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">token_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;inputs-partition-&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">random_position_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;random-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">position_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">numeric_tokens</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="c1"># tokens_positions.append((token))</span>
                <span class="c1"># check if the absolute value of the token is less than the length of the string tokens</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2"> is out of range&quot;</span><span class="p">)</span>
                <span class="n">numeric_tokens</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">token</span>
                <span class="c1"># check if the start and end are within the range of the string tokens</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2"> is out of range&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2"> is invalid. The start index must be less than the end index&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">end</span>
                <span class="n">numeric_tokens</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-inputs-partition-&quot;</span><span class="p">):</span>
                <span class="n">group</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_random_group_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">random_position_dict</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="n">position_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;inputs-partition-</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-image&quot;</span><span class="p">):</span>

                <span class="n">n</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">random_position_dict</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">n</span> <span class="k">if</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-text&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;random-text&quot;</span><span class="p">:</span>
                    <span class="n">random_position_dict</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                        <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="mi">1</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">random_position_dict</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                        <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">n</span> <span class="k">if</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">1</span>
                    <span class="p">)</span>

        <span class="n">token_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_token_dict</span><span class="p">(</span><span class="n">token_indexes</span><span class="p">,</span> <span class="n">random_position_dict</span><span class="p">)</span>
        <span class="c1"># add the numeric indexe</span>
        <span class="n">token_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">token_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">numeric_tokens</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token_dict</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tokens_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">token_dict</span><span class="p">[</span><span class="n">token</span><span class="p">]))</span>  <span class="c1"># type: ignore</span>

        <span class="k">return</span> <span class="n">tokens_positions</span><span class="p">,</span> <span class="n">token_dict</span>

    <span class="k">def</span> <span class="nf">parse_random_group_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">group_and_n</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_and_n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">group</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">group_and_n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">group_and_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">group</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_token_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">token_indexes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">random_position_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;last-2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;last-4&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span>
            <span class="s2">&quot;last-image&quot;</span><span class="p">:</span> <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;last_line_image&quot;</span><span class="p">],</span>
            <span class="s2">&quot;end-image&quot;</span><span class="p">:</span> <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;image_end&quot;</span><span class="p">],</span>
            <span class="s2">&quot;all-text&quot;</span><span class="p">:</span> <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
            <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">],</span>
            <span class="s2">&quot;all-image&quot;</span><span class="p">:</span> <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span>
            <span class="s2">&quot;special&quot;</span><span class="p">:</span> <span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;special&quot;</span><span class="p">],</span>
            <span class="s2">&quot;random-text&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])],</span>
            <span class="s2">&quot;random-image&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">token_indexes</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">])],</span>
            <span class="s2">&quot;special-pixtral&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1052</span><span class="p">,</span> <span class="mi">1051</span><span class="p">,</span> <span class="mi">1038</span><span class="p">,</span> <span class="mi">991</span><span class="p">,</span> <span class="mi">1037</span><span class="p">,</span> <span class="mi">1047</span><span class="p">],</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">token_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;inputs-partition-&quot;</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="o">**</span><span class="n">random_position_dict</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="easyroutine.interpretability.token_index.TokenIndex.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">pivot_positions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pivot_tokens</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>str (required): the name of the model</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pivot_positions</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[int] (optional): a list of integers that represent the positions where to split the tokens.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pivot_tokens</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[str] (optional): a list of strings that represent the tokens where to split the tokens.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>The pivot_positions and pivot_tokens are mutually exclusive.
The idea of the split is the following. Immagine to have an input string of tokens like this: ["I", "love", "cats", "and", "dogs". "What", "about", "you?"]
Then, i want to extract/ablate/intervene on the second sentence. I can do it by specifying the pivot_positions=[5] or pivot_tokens=["What"].
In this way, the tokens will be split in two groups: ["I", "love", "cats", "and"] and ["dogs", "What", "about", "you?"] with names "inputs-partition-0" and "inputs-partition-1".</p>


            <details class="quote">
              <summary>Source code in <code>easyroutine/interpretability/token_index.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pivot_positions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pivot_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        model_name: str (required): the name of the model</span>
<span class="sd">        pivot_positions: List[int] (optional): a list of integers that represent the positions where to split the tokens.</span>
<span class="sd">        pivot_tokens: List[str] (optional): a list of strings that represent the tokens where to split the tokens.</span>


<span class="sd">    The pivot_positions and pivot_tokens are mutually exclusive.</span>
<span class="sd">    The idea of the split is the following. Immagine to have an input string of tokens like this: [&quot;I&quot;, &quot;love&quot;, &quot;cats&quot;, &quot;and&quot;, &quot;dogs&quot;. &quot;What&quot;, &quot;about&quot;, &quot;you?&quot;]</span>
<span class="sd">    Then, i want to extract/ablate/intervene on the second sentence. I can do it by specifying the pivot_positions=[5] or pivot_tokens=[&quot;What&quot;].</span>
<span class="sd">    In this way, the tokens will be split in two groups: [&quot;I&quot;, &quot;love&quot;, &quot;cats&quot;, &quot;and&quot;] and [&quot;dogs&quot;, &quot;What&quot;, &quot;about&quot;, &quot;you?&quot;] with names &quot;inputs-partition-0&quot; and &quot;inputs-partition-1&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pivot_tokens</span> <span class="o">=</span> <span class="n">pivot_tokens</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pivot_positions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pivot_positions</span><span class="p">)</span> <span class="k">if</span> <span class="n">pivot_positions</span> <span class="k">else</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="easyroutine.interpretability.token_index.TokenIndex.get_token_index" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_token_index</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">string_tokens</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get indices for specified tokens in the input sequence.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tokens</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.List">List</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="int">int</span>, <span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]]], <span title="typing.List">List</span>[<span title="str">str</span>], <span title="typing.List">List</span>[<span title="int">int</span>], <span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of tokens to look up. Can be:
- String token identifiers (see Supported Tokens below)
- Integer indices (direct position access)
- Tuple[int, int] for slices (start, end)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>string_tokens</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token sequence to search in</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_type</code>
            </td>
            <td>
                  <code><span title="typing_extensions.Literal">Literal</span>[&#39;list&#39;, &#39;dict&#39;, &#39;all&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output format:
- "list": Returns [int, ...]
- "dict": Returns {"token_type": [indices]}
- "all": Returns ([indices], {token_type: [indices]})</p>
              </div>
            </td>
            <td>
                  <code>&#39;list&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.List">List</span>[<span title="int">int</span>], <span title="typing.Dict">Dict</span>, <span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[<span title="int">int</span>], <span title="typing.Dict">Dict</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Based on return_type, provides token indices in specified format</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="token-types" open>
  <summary>Token Types</summary>
  <ol>
<li>
<p>Direct Access:</p>
<ul>
<li>Integer index: Direct position (e.g. 5)</li>
<li>Slice tuple: Range of positions (e.g. (2,5))</li>
<li>Negative index: From end (e.g. -1)</li>
</ul>
</li>
<li>
<p>Named Positions:</p>
<ul>
<li>"last": Last token</li>
<li>"last-2": Second to last</li>
<li>"last-4": Fourth to last</li>
</ul>
</li>
<li>
<p>Text Tokens:</p>
<ul>
<li>"all-text": All text positions</li>
<li>"random-text": Single random text position</li>
<li>"random-text-N": N random text positions</li>
</ul>
</li>
<li>
<p>Image Tokens:</p>
<ul>
<li>"all-image": All image positions</li>
<li>"last-image": Last image position</li>
<li>"end-image": Image end marker</li>
<li>"random-image": Random image position</li>
<li>"random-image-N": N random image positions</li>
</ul>
</li>
<li>
<p>Special:</p>
<ul>
<li>"special": Model-specific tokens</li>
<li>"all": Complete sequence</li>
<li>"special-pixtral": Model-specific fixed positions</li>
<li>"inputs-partition-N": Nth token group</li>
<li>"random-inputs-partition-N": Random from group N</li>
</ul>
</li>
</ol>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <h4 id="easyroutine.interpretability.token_index.TokenIndex.get_token_index--direct-index-access">Direct index access</h4>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">get_token_index</span><span class="p">([</span><span class="mi">5</span><span class="p">],</span> <span class="n">tokens</span><span class="p">)</span>               <span class="c1"># Single position</span>
<span class="go">[5]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_token_index</span><span class="p">([(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)],</span> <span class="n">tokens</span><span class="p">)</span>          <span class="c1"># Slice range</span>
<span class="go">[2,3,4]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_token_index</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tokens</span><span class="p">)</span>             <span class="c1"># From end</span>
<span class="go">[9]</span>
</code></pre></div>
    <h4 id="easyroutine.interpretability.token_index.TokenIndex.get_token_index--named-tokens">Named tokens</h4>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">get_token_index</span><span class="p">([</span><span class="s2">&quot;last&quot;</span><span class="p">],</span> <span class="n">tokens</span><span class="p">)</span>         <span class="c1"># Last token</span>
<span class="go">[9]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_token_index</span><span class="p">([</span><span class="s2">&quot;all-text&quot;</span><span class="p">],</span> <span class="n">tokens</span><span class="p">)</span>     <span class="c1"># All text</span>
<span class="go">[0,1,2,3]</span>
</code></pre></div>
    <h4 id="easyroutine.interpretability.token_index.TokenIndex.get_token_index--mixed-usage">Mixed usage</h4>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">get_token_index</span><span class="p">([</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)],</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;dict&quot;</span><span class="p">)</span>
<span class="go">{&quot;last&quot;: [9], &quot;numeric&quot;: [2,3,4]}</span>
</code></pre></div>
    <h4 id="easyroutine.interpretability.token_index.TokenIndex.get_token_index--partition-access">Partition access</h4>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">get_token_index</span><span class="p">([</span><span class="s2">&quot;inputs-partition-0&quot;</span><span class="p">],</span> <span class="n">tokens</span><span class="p">)</span>  <span class="c1"># First group</span>
<span class="go">[0,1,2]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_token_index</span><span class="p">([</span><span class="s2">&quot;random-inputs-partition-0&quot;</span><span class="p">],</span> <span class="n">tokens</span><span class="p">)</span> <span class="c1"># Random from group</span>
<span class="go">[1]</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>easyroutine/interpretability/token_index.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_token_index</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
        <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">string_tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">return_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get indices for specified tokens in the input sequence.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        tokens: list of tokens to look up. Can be:</span>
<span class="sd">            - String token identifiers (see Supported Tokens below)</span>
<span class="sd">            - Integer indices (direct position access)</span>
<span class="sd">            - Tuple[int, int] for slices (start, end)</span>
<span class="sd">        string_tokens: Input token sequence to search in</span>
<span class="sd">        return_type: Output format:</span>
<span class="sd">            - &quot;list&quot;: Returns [int, ...]</span>
<span class="sd">            - &quot;dict&quot;: Returns {&quot;token_type&quot;: [indices]}</span>
<span class="sd">            - &quot;all&quot;: Returns ([indices], {token_type: [indices]})</span>

<span class="sd">    Returns:</span>
<span class="sd">        Based on return_type, provides token indices in specified format</span>

<span class="sd">    Token Types:</span>
<span class="sd">        1. Direct Access:</span>
<span class="sd">            - Integer index: Direct position (e.g. 5)</span>
<span class="sd">            - Slice tuple: Range of positions (e.g. (2,5))</span>
<span class="sd">            - Negative index: From end (e.g. -1)</span>

<span class="sd">        2. Named Positions:</span>
<span class="sd">            - &quot;last&quot;: Last token</span>
<span class="sd">            - &quot;last-2&quot;: Second to last</span>
<span class="sd">            - &quot;last-4&quot;: Fourth to last</span>

<span class="sd">        3. Text Tokens:</span>
<span class="sd">            - &quot;all-text&quot;: All text positions</span>
<span class="sd">            - &quot;random-text&quot;: Single random text position</span>
<span class="sd">            - &quot;random-text-N&quot;: N random text positions</span>

<span class="sd">        4. Image Tokens:</span>
<span class="sd">            - &quot;all-image&quot;: All image positions</span>
<span class="sd">            - &quot;last-image&quot;: Last image position</span>
<span class="sd">            - &quot;end-image&quot;: Image end marker</span>
<span class="sd">            - &quot;random-image&quot;: Random image position</span>
<span class="sd">            - &quot;random-image-N&quot;: N random image positions</span>

<span class="sd">        5. Special:</span>
<span class="sd">            - &quot;special&quot;: Model-specific tokens</span>
<span class="sd">            - &quot;all&quot;: Complete sequence</span>
<span class="sd">            - &quot;special-pixtral&quot;: Model-specific fixed positions</span>
<span class="sd">            - &quot;inputs-partition-N&quot;: Nth token group</span>
<span class="sd">            - &quot;random-inputs-partition-N&quot;: Random from group N</span>

<span class="sd">    Examples:</span>
<span class="sd">        # Direct index access</span>
<span class="sd">        &gt;&gt;&gt; get_token_index([5], tokens)               # Single position</span>
<span class="sd">        [5]</span>
<span class="sd">        &gt;&gt;&gt; get_token_index([(2,5)], tokens)          # Slice range</span>
<span class="sd">        [2,3,4]</span>
<span class="sd">        &gt;&gt;&gt; get_token_index([-1], tokens)             # From end</span>
<span class="sd">        [9]</span>

<span class="sd">        # Named tokens</span>
<span class="sd">        &gt;&gt;&gt; get_token_index([&quot;last&quot;], tokens)         # Last token</span>
<span class="sd">        [9]</span>
<span class="sd">        &gt;&gt;&gt; get_token_index([&quot;all-text&quot;], tokens)     # All text</span>
<span class="sd">        [0,1,2,3]</span>

<span class="sd">        # Mixed usage</span>
<span class="sd">        &gt;&gt;&gt; get_token_index([&quot;last&quot;, (2,5)], tokens, return_type=&quot;dict&quot;)</span>
<span class="sd">        {&quot;last&quot;: [9], &quot;numeric&quot;: [2,3,4]}</span>

<span class="sd">        # Partition access</span>
<span class="sd">        &gt;&gt;&gt; get_token_index([&quot;inputs-partition-0&quot;], tokens)  # First group</span>
<span class="sd">        [0,1,2]</span>
<span class="sd">        &gt;&gt;&gt; get_token_index([&quot;random-inputs-partition-0&quot;], tokens) # Random from group</span>
<span class="sd">        [1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert single token to list for uniform processing</span>
    <span class="c1"># assert that we have a list of tokens</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Tokens must be a list of strings or integers or tuples. Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Check if all tokens are supported or not</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
        <span class="n">token</span> <span class="ow">in</span> <span class="n">SUPPORTED_TOKENS</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;inputs-partition-&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-inputs-partition-&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-image&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-text&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported token type into: </span><span class="si">{</span><span class="n">tokens</span><span class="si">}</span><span class="s2">. Supported tokens are: </span><span class="si">{</span><span class="n">SUPPORTED_TOKENS</span><span class="si">}</span><span class="s2"> and inputs-partition-0, inputs-partition-1, etc or random-inputs-partition-0, random-inputs-partition-1, etc or integer indices or slices (tuple of start, end)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Check if pivot_positions is required but not provided</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot_positions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="ow">and</span> <span class="p">(</span>
            <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;inputs-partition-&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;random-inputs-partition-&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;pivot_positions cannot be None when a group position token is requested&quot;</span>
        <span class="p">)</span>

    <span class="n">token_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorize_tokens</span><span class="p">(</span><span class="n">string_tokens</span><span class="p">)</span>
    <span class="n">tokens_positions</span><span class="p">,</span> <span class="n">token_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tokens_positions</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">token_indexes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">token_dict</span>
    <span class="k">if</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tokens_positions</span><span class="p">,</span> <span class="n">token_dict</span>
    <span class="k">return</span> <span class="n">tokens_positions</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>