
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://easyroutine.github.io/api/interpretability/tools/">
      
      
        <link rel="prev" href="../token_index/">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Interpretability Tools - EasyRoutine</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#interpretability-tools" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="EasyRoutine" class="md-header__button md-logo" aria-label="EasyRoutine" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EasyRoutine
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Interpretability Tools
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="EasyRoutine" class="md-nav__button md-logo" aria-label="EasyRoutine" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    EasyRoutine
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Api
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Api
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Interpretability
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Interpretability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../activation_cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Activation cache
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hooked_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hooked model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../interventions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interventions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Module Wrapper
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../token_index/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Token index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Interpretability Tools
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Interpretability Tools
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#logitlens" class="md-nav__link">
    <span class="md-ellipsis">
      LogitLens
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LogitLens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-reference" class="md-nav__link">
    <span class="md-ellipsis">
      API Reference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logitlens-constructor" class="md-nav__link">
    <span class="md-ellipsis">
      LogitLens Constructor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Class Methods
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Core Methods
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-analyzing-mid-layer-predictions" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Analyzing Mid-layer Predictions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#activationsaver" class="md-nav__link">
    <span class="md-ellipsis">
      ActivationSaver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ActivationSaver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features_1" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage_1" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-reference_1" class="md-nav__link">
    <span class="md-ellipsis">
      API Reference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#activationsaver_1" class="md-nav__link">
    <span class="md-ellipsis">
      ActivationSaver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activationloader" class="md-nav__link">
    <span class="md-ellipsis">
      ActivationLoader
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#query-results" class="md-nav__link">
    <span class="md-ellipsis">
      Query Results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-comprehensive-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Comprehensive Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#logitlens" class="md-nav__link">
    <span class="md-ellipsis">
      LogitLens
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LogitLens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-reference" class="md-nav__link">
    <span class="md-ellipsis">
      API Reference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logitlens-constructor" class="md-nav__link">
    <span class="md-ellipsis">
      LogitLens Constructor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Class Methods
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Core Methods
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-analyzing-mid-layer-predictions" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Analyzing Mid-layer Predictions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#activationsaver" class="md-nav__link">
    <span class="md-ellipsis">
      ActivationSaver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ActivationSaver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features_1" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage_1" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-reference_1" class="md-nav__link">
    <span class="md-ellipsis">
      API Reference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#activationsaver_1" class="md-nav__link">
    <span class="md-ellipsis">
      ActivationSaver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activationloader" class="md-nav__link">
    <span class="md-ellipsis">
      ActivationLoader
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#query-results" class="md-nav__link">
    <span class="md-ellipsis">
      Query Results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-comprehensive-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Comprehensive Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="interpretability-tools">Interpretability Tools</h1>
<p>This section covers the tools provided by <code>easyroutine</code> for model interpretability beyond basic activation extraction.</p>
<h2 id="logitlens">LogitLens</h2>
<p><code>LogitLens</code> is a powerful tool that enables you to interpret intermediate representations in transformer models by projecting them through the model's output head to the vocabulary space. This technique, often called "logit lens" in the mechanistic interpretability literature, allows researchers to understand what token predictions would be made at each layer, providing insights into how representations evolve through the network.</p>
<h3 id="key-features">Key Features</h3>
<ul>
<li>Project any intermediate activation to token probability space</li>
<li>Apply proper layer normalization based on model architecture (supports both LayerNorm and RMSNorm)</li>
<li>Compute metrics like logit differences between specific token directions</li>
<li>Support for various model architectures with different normalization schemes</li>
</ul>
<h3 id="usage">Usage</h3>
<pre><code class="language-python">from easyroutine.interpretability import HookedModel
from easyroutine.interpretability.tools import LogitLens

# Create a model
model = HookedModel.from_pretrained(&quot;mistralai/Mistral-7B-v0.1&quot;)

# Create LogitLens from the model
logit_lens = LogitLens.from_model(model)

# Run forward pass and collect activations
cache = model.forward(
    inputs, 
    target_token_positions=[&quot;last&quot;],
    extraction_config=ExtractionConfig(
        extract_resid_out=True,
        extract_last_layernorm=True  # Required for proper normalization
    )
)

# Analyze residual streams from different layers using LogitLens
layer = 12  # Specify which layer to analyze
results = logit_lens.compute(
    activations=cache, 
    target_key=f&quot;resid_out_{layer}&quot;, 
    apply_norm=True,
    apply_softmax=True  # Set to True if you want probabilities instead of logits
)

# To compute logit difference between two specific tokens
token_diff_results = logit_lens.compute(
    activations=cache,
    target_key=f&quot;resid_out_{layer}&quot;,
    token_directions=[(model.hf_tokenizer.encode(&quot; yes&quot;)[0], model.hf_tokenizer.encode(&quot; no&quot;)[0])],
    metric=&quot;logit_diff&quot;
)
</code></pre>
<h3 id="api-reference">API Reference</h3>
<h4 id="logitlens-constructor">LogitLens Constructor</h4>
<pre><code class="language-python">def __init__(self, unembedding_matrix, last_layer_norm, model_name, model_config):
</code></pre>
<p><strong>Arguments:</strong>
- <code>unembedding_matrix</code>: The weight matrix used in the model's output embedding layer
- <code>last_layer_norm</code>: The model's final layer normalization module
- <code>model_name</code>: Name of the model
- <code>model_config</code>: Model configuration object containing architecture details</p>
<h4 id="class-methods">Class Methods</h4>
<pre><code class="language-python">@classmethod
def from_model(cls, model: HookedModel) -&gt; 'LogitLens'
</code></pre>
<p>Create a LogitLens instance from a HookedModel.</p>
<pre><code class="language-python">@classmethod
def from_model_name(cls, model_name: str) -&gt; 'LogitLens'
</code></pre>
<p>Create a LogitLens instance directly from a model name (will load the model).</p>
<h4 id="core-methods">Core Methods</h4>
<pre><code class="language-python">def compute(
    self,
    activations: ActivationCache,
    target_key: str,
    token_directions: Optional[Union[List[int], List[Tuple[int, int]]]] = None,
    apply_norm: bool = True,
    apply_softmax: bool = False,
    metric: Optional[Literal[&quot;logit_diff&quot;, &quot;accuracy&quot;]] = &quot;logit_diff&quot;
) -&gt; dict:
</code></pre>
<p><strong>Arguments:</strong>
- <code>activations</code>: ActivationCache containing model activations
- <code>target_key</code>: The key/pattern for activations to analyze (e.g., "resid_out_{i}")
- <code>token_directions</code>: Optional list of token IDs or pairs to compute specific direction metrics
- <code>apply_norm</code>: Whether to apply layer normalization to the activations
- <code>apply_softmax</code>: Whether to apply softmax to get probabilities instead of raw logits
- <code>metric</code>: Metric to compute if token_directions are provided ("logit_diff" or "accuracy")</p>
<p><strong>Returns:</strong>
- Dictionary with computed logit lens results</p>
<h3 id="example-analyzing-mid-layer-predictions">Example: Analyzing Mid-layer Predictions</h3>
<pre><code class="language-python">import torch
from easyroutine.interpretability import HookedModel, ExtractionConfig
from easyroutine.interpretability.tools import LogitLens

model = HookedModel.from_pretrained(&quot;gpt2&quot;)
logit_lens = LogitLens.from_model(model)

# Create a prompt
tokenizer = model.get_tokenizer()
prompt = &quot;The capital of France is&quot;
inputs = tokenizer(prompt, return_tensors=&quot;pt&quot;)

# Extract activations from all layers
cache = model.forward(
    inputs, 
    target_token_positions=[&quot;last&quot;],
    extraction_config=ExtractionConfig(
        extract_resid_out=True,
        extract_last_layernorm=True
    )
)

# Analyze how the prediction for the last token evolves through layers
results = {}
for layer in range(model.model_config.num_hidden_layers):
    layer_results = logit_lens.compute(
        activations=cache, 
        target_key=f&quot;resid_out_{layer}&quot;, 
        apply_norm=True,
        apply_softmax=True
    )

    # Get top 5 tokens for the last position
    logits = layer_results[f&quot;logit_lens_resid_out_{layer}&quot;][0, -1]
    top_tokens = torch.topk(logits, 5)

    results[layer] = [
        (tokenizer.decode(idx.item()), prob.item()) 
        for idx, prob in zip(top_tokens.indices, top_tokens.values)
    ]

# Print results to see how predictions evolve
for layer, tokens in results.items():
    print(f&quot;Layer {layer}: {tokens}&quot;)
</code></pre>
<p>This example shows how to track the evolution of predictions through the layers of the model, providing insights into how the model builds up its final prediction.</p>
<h2 id="activationsaver">ActivationSaver</h2>
<p><code>ActivationSaver</code> is a utility that provides a structured way to save and load model activations with rich metadata. This is particularly useful for large-scale experiments where you want to save activations for later analysis.</p>
<h3 id="key-features_1">Key Features</h3>
<ul>
<li>Structured filesystem organization for saved activations</li>
<li>Automatic metadata tracking (model, configuration, extraction details)</li>
<li>Tagging system for easier identification of specific runs</li>
<li>Query functionality through companion <code>ActivationLoader</code> class</li>
<li>Supports renaming experiments and organizing workspace</li>
</ul>
<h3 id="usage_1">Usage</h3>
<pre><code class="language-python">from easyroutine.interpretability import HookedModel, ExtractionConfig
from easyroutine.interpretability.activation_saver import ActivationSaver

# Create a model and extract activations
model = HookedModel.from_pretrained(&quot;gpt2&quot;)
inputs = tokenizer(&quot;Hello, world!&quot;, return_tensors=&quot;pt&quot;)

cache = model.forward(
    inputs, 
    target_token_positions=[&quot;last&quot;],
    extraction_config=ExtractionConfig(extract_resid_out=True)
)

# Save activations with metadata
saver = ActivationSaver(base_dir=&quot;./saved_activations&quot;, experiment_name=&quot;hello_world_test&quot;)
save_dir = saver.save(
    activations=cache,
    model=model,
    target_token_positions=[&quot;last&quot;],
    interventions=None,
    extraction_config=ExtractionConfig(extract_resid_out=True),
    tag=&quot;first_test&quot;
)

# Or use the simplified method if the cache already contains metadata
# This is the case with caches created using model.extract_cache()
dataset_cache = model.extract_cache(
    dataloader,
    target_token_positions=[&quot;last&quot;],
    extraction_config=ExtractionConfig(extract_resid_out=True)
)
saver.save_cache(dataset_cache, tag=&quot;dataset_run&quot;)
</code></pre>
<h3 id="api-reference_1">API Reference</h3>
<h4 id="activationsaver_1">ActivationSaver</h4>
<pre><code class="language-python">def __init__(self, base_dir: Union[Path, str], experiment_name: str = &quot;default&quot;)
</code></pre>
<p><strong>Arguments:</strong>
- <code>base_dir</code>: Base directory where activations will be saved
- <code>experiment_name</code>: Name of the experiment (creates a subdirectory)</p>
<pre><code class="language-python">@classmethod
def from_env(cls, experiment_name: str = &quot;default&quot;)
</code></pre>
<p>Create a saver using the base directory specified in the environment variable <code>ACTIVATION_BASE_DIR</code></p>
<pre><code class="language-python">def save(
    self,
    activations: Union[torch.Tensor, dict, ActivationCache],
    model: HookedModel,
    target_token_positions,
    interventions: Optional[List[Intervention]],
    extraction_config: ExtractionConfig,
    other_metadata: dict = {},
    tag: Optional[str] = None,
)
</code></pre>
<p><strong>Arguments:</strong>
- <code>activations</code>: The activation cache or tensor to save
- <code>model</code>: The HookedModel used to generate the activations
- <code>target_token_positions</code>: The token positions used during extraction
- <code>interventions</code>: Any interventions applied during extraction
- <code>extraction_config</code>: The extraction configuration used
- <code>other_metadata</code>: Additional metadata to store
- <code>tag</code>: Optional tag for easier identification</p>
<p><strong>Returns:</strong>
- The directory path where activations were saved</p>
<pre><code class="language-python">def save_cache(
    self,
    cache: ActivationCache,
    other_metadata: dict = {},
    tag: Optional[str] = None,
)
</code></pre>
<p>A simplified save method that expects the cache to already contain metadata.</p>
<pre><code class="language-python">def rename_experiment(self, new_experiment_name: str)
</code></pre>
<p>Renames the experiment directory and updates all metadata files within it.</p>
<h4 id="activationloader">ActivationLoader</h4>
<pre><code class="language-python">def __init__(self, base_dir: Path, experiment_name: str = &quot;default&quot;)
</code></pre>
<p><strong>Arguments:</strong>
- <code>base_dir</code>: Base directory where activations are saved
- <code>experiment_name</code>: Name of the experiment to load from</p>
<pre><code class="language-python">@classmethod
def from_env(cls, experiment_name: str = &quot;default&quot;)
</code></pre>
<p>Create a loader using the base directory specified in the environment variable <code>ACTIVATION_BASE_DIR</code></p>
<pre><code class="language-python">@classmethod
def from_saver(cls, saver: ActivationSaver)
</code></pre>
<p>Create a loader from an existing ActivationSaver</p>
<pre><code class="language-python">def query(
    self,
    experiment_name: Optional[str] = None,
    model_name: Optional[str] = None,
    target_token_positions: Optional[List[Union[str, int]]] = None,
    pivot_positions: Optional[List[int]] = None,
    save_time: Optional[str] = None,
    custom_keys: Optional[dict] = None,
    extraction_config: Optional[ExtractionConfig] = None,
    interventions: Optional[List[Intervention]] = None,
    tag: Optional[str] = None,
) -&gt; QueryResult
</code></pre>
<p>Search for saved activations based on various criteria.</p>
<p><strong>Arguments:</strong>
- Various search criteria to filter saved activations</p>
<p><strong>Returns:</strong>
- A QueryResult object containing matching runs</p>
<h3 id="query-results">Query Results</h3>
<p>The <code>QueryResult</code> class provides a convenient interface for managing the results of queries:</p>
<pre><code class="language-python"># List all matching runs
print(query_result)

# Get detailed paths
print(query_result.get_paths())

# Load a specific run by index (e.g., most recent with -1)
activations, metadata = query_result.load(-1)

# Load by specific time folder
activations, metadata = query_result.load(&quot;2023-04-15_14-30-25&quot;)

# Remove a specific run
query_result.remove(-1)  # Remove the most recent run

# Update experiment name for a run
query_result.update_run_experiment(-1, &quot;new_experiment_name&quot;)
</code></pre>
<h3 id="example-comprehensive-workflow">Example: Comprehensive Workflow</h3>
<pre><code class="language-python">import torch
from easyroutine.interpretability import HookedModel, ExtractionConfig
from easyroutine.interpretability.activation_saver import ActivationSaver, ActivationLoader

# 1. Create model and dataset
model = HookedModel.from_pretrained(&quot;gpt2&quot;)
tokenizer = model.get_tokenizer()

# Create a simple dataset
texts = [&quot;Example text 1&quot;, &quot;Example text 2&quot;, &quot;Example text 3&quot;]
dataset = [tokenizer(text, return_tensors=&quot;pt&quot;) for text in texts]

# 2. Extract and save activations
saver = ActivationSaver(base_dir=&quot;./saved_activations&quot;, experiment_name=&quot;documentation_example&quot;)

for i, inputs in enumerate(dataset):
    # Extract activations for this batch
    cache = model.forward(
        inputs, 
        target_token_positions=[&quot;last&quot;],
        extraction_config=ExtractionConfig(
            extract_resid_out=True,
            extract_attn_pattern=True
        )
    )

    # Save with batch-specific tag
    saver.save(
        activations=cache,
        model=model,
        target_token_positions=[&quot;last&quot;],
        interventions=None,
        extraction_config=ExtractionConfig(
            extract_resid_out=True,
            extract_attn_pattern=True
        ),
        other_metadata={&quot;batch_id&quot;: i},
        tag=f&quot;batch_{i}&quot;
    )

# 3. Load and analyze results later
loader = ActivationLoader.from_saver(saver)

# Query for specific batch
batch_0_results = loader.query(tag=&quot;batch_0&quot;)
activations, metadata = batch_0_results.load(-1)  # Load the most recent match

# Query by custom metadata
specific_batch = loader.query(custom_keys={&quot;batch_id&quot;: 1})
activations, metadata = specific_batch.load(-1)

# Query by model name and extraction configuration
all_gpt2_runs = loader.query(
    model_name=&quot;gpt2&quot;,
    extraction_config=ExtractionConfig(extract_attn_pattern=True)
)

print(f&quot;Found {len(all_gpt2_runs.results)} matching runs&quot;)
</code></pre>
<p>This example demonstrates a complete workflow of extracting activations from multiple inputs, saving them with metadata, and later querying and loading them for analysis.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>